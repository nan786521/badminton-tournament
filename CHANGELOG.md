# 羽球賽務系統 — 修改紀錄

## v1.30

### 2026-02-20

#### 新功能
- **清除資料按鈕**：標題列新增「清除」按鈕，可一鍵清除目前賽事的所有暫存資料（名單、分組、比分、決賽結果），避免舊資料影響新的成績輸入。清除前會彈出確認視窗，並保留賽事名稱與賽事 ID。

## v1.29

### 2026-02-20

#### UI 改善
- **預賽類別決賽管理區**：2 人/3 人單組類別進入決賽管理區時：
  - 隱藏不適用的對戰圖按鈕（抽籤、產生對戰圖、出賽單等）
  - 顯示專用按鈕列：「成績公告」+「綜合報表」
  - 顯示完整排名（冠軍/亞軍/季軍）取代僅顯示 1 名晉級者
  - 結果卡片含獎牌顯示 + 列印/下載按鈕
- **promoteWinners 初始渲染修正**：結算冠軍後改為呼叫 `switchFinalsCategory()`，確保預賽類別立即顯示結果卡片

## v1.28

### 2026-02-20

#### Bug Fix
- **決賽對戰圖自動產生**：`promoteWinners()` 現在為所有項目自動產生對戰圖（不再限定只有 2 人晉級的項目才自動產生）
  - 修復 5 人類別（3+2 分組、4 人晉級）無法自動產生對戰圖的問題
  - 同組 2 人預賽成績自動帶入決賽，免手動重複輸入
  - 勝者自動晉級下一輪、敗者導向季軍賽

#### 新功能
- **單組類別成績公告**：2 人/3 人等單組類別（預賽直接決定名次）現在也能輸出成績公告 PDF
  - 新增 `state.prelimResults` 儲存預賽完整排名（冠軍、亞軍、季軍、殿軍）
  - `getBracketResultsForCategory()` 增加 fallback，無對戰圖時讀取預賽排名
  - 決賽管理區對預賽決定的類別顯示結果卡 + 「列印/下載成績公告」按鈕
  - 成績公告 PDF 與綜合報表 PDF 皆正確顯示預賽對戰明細

## v1.27

### 2026-02-20

#### 安全性修復
- **XSS 修復**：`customConfirm()` 改用 `textContent` + DOM API 建構，不再以 innerHTML 注入使用者訊息
- **XSS 修復**：`showEventManager()` 改用 DOM API + closure 綁定事件，移除 inline onclick 中的 ID 注入

#### 程式碼品質
- **統一序列化**：新增 `serializeState()` 函式，`saveState()` / `takeSnapshot()` / `saveToExcel()` 三處共用，避免欄位遺漏或不一致
- **取代 prompt()**：新增 `customPrompt()` modal 對話框，取代出賽單的原生 `prompt()`，UI 風格一致

#### 效能優化
- **CDN 延遲載入**：xlsx（400KB）、html2canvas（200KB）、qrcode（30KB）改為按需載入，首次開啟頁面減少 ~630KB 下載量
- **localStorage 容量檢查**：`saveState()` 新增 `QuotaExceededError` 偵測，空間不足時顯示中文提示

#### 可及性
- **棄權徽章鍵盤操作**：所有 `.ff-badge` 加入 `tabindex="0"` + `role="button"`，支援 Enter/Space 鍵觸發

#### PWA
- **Service Worker 更新策略**：HTML 改為 network-first（確保版本更新送達），靜態資源維持 cache-first；cache key 同步版本號

## v1.26

### 2026-02-20

- 成績公告與綜合報表版面優化：長校名（如九份子國小）不再溢出 podium 方塊
- podium 改用 flex:1 + word-break:keep-all，自動分配寬度
- 對戰明細表格選手名不折行（white-space:nowrap + 字型縮小）
- 殿軍雙打時標籤獨立一行，兩位選手名稱置中對齊
- 殿軍移除冒號

## v1.25

### 2026-02-20

- 雙打成績公告與綜合報表中選手姓名改為兩列顯示（學校+選手A / 學校+選手B）
- 適用範圍：成績公告（podium + 對戰明細）、綜合報表決賽區段（podium + 對戰明細）
- 自動偵測類別是否為雙打，單打類別不受影響

## v1.24

### 2026-02-20

- 雙打對戰圖 SVG 選手姓名改為兩列顯示（學校+選手A / 學校+選手B），不再擠在同一行
- 雙打 bracket 自動加高 slot，確保兩列文字不重疊

## v1.23

### 2026-02-20

- 修正橫向列印 SVG 被截斷：加入 `max-height` 動態限制，橫向 190mm / 直向 275mm，確保內容不超出頁面
- 預賽對戰圖（列印）移除決賽 bracket，僅保留預賽分組圖
- 列印視窗 body 在 print 模式下 margin 歸零，最大化可印面積
- 出賽單固定直式列印，移除方向選擇器（版面為 A4 直式設計）

## v1.22

### 2026-02-19

- 所有列印視窗新增「橫向/直向」方向選擇器，可自由切換列印與 PDF 下載的紙張方向
- 適用範圍：決賽對戰圖、成績公告、綜合報表、出賽單、預賽對戰圖（共 5 種列印頁面）
- 各頁面預設方向依內容特性設定（對戰圖預設橫向、其餘預設直向）
- 列印與 PDF 下載均依所選方向輸出

## v1.21

### 2026-02-19

- 修正對戰圖 PDF 裁切 bug：SVG viewBox 寬度改為實際計算寬度（不再固定 800px），多輪 bracket 不再被右側截斷
- 大型 bracket 動態縮放：`matchH` 依人數自動調整（50→26px），保持 A4 頁面可讀性
- PDF 列印/下載統一橫向 A4（`@page { size: landscape }`）
- 超高 bracket 自動分頁輸出

## v1.20

### 2026-02-19

- BYE 均勻分佈：使用標準種子排位（`bracketSeedOrder`）將輪空分散到 bracket 各半區，確保四強全為真人選手
- 修正 24 人 bracket 中 BYE 全擠底部導致殿軍缺失的問題
- 「第四名」統一改稱「殿軍」
- 評分表、出賽單、PDF 對戰圖同步套用均勻 BYE 分佈

## v1.19

### 2026-02-19

- 決賽合併為項目制：同一工作表（類別）的所有預賽組晉級者合併為一個決賽 bracket
- 修正 v1.17 的 per-group 分割邏輯，回歸標準賽制（一個項目 = 一個冠軍）
- 晉級者標籤顯示來源組別（如「A組第1名」）

## v1.18

### 2026-02-19

- 3 人組預賽季軍：當預賽組別僅 3 名選手時，未晉級的第 3 名自動標記為該組季軍，顯示於決賽結果中
- 新增 `state.prelimBronze` 字典，儲存各決賽 key 的預賽季軍名稱
- 完整支援存檔/載入/Undo/Redo 持久化

## v1.17

### 2026-02-19

- 決賽分組獨立：多組類別（如「高女單」A 組 + B 組）各組擁有獨立 bracket 和冠亞軍結果，不再合併覆蓋
- 單組類別維持原本行為（直接以類別名稱為 key）
- 搭配 v1.16 自動完賽，2 人組結算後可直接輸出各組比賽結果

## v1.16

### 2026-02-19

- 2 人同組決賽自動完賽：若 2 名晉級者來自同一預賽組，自動帶入預賽比分並確認勝者，可直接輸出比賽結果圖
- Toast 提示「N 組已自動完賽」

## v1.15

### 2026-02-19

- 2 人決賽自動產生對戰圖：結算冠軍時，若類別只有 2 名晉級者，自動建立 bracket，不需手動點「產生對戰圖」
- 重構 `buildBracketMatches()` 為獨立 helper，供 `generateBracket()` 和 `promoteWinners()` 共用
- Toast 提示自動產生的組數

## v1.14

### 2026-02-19

#### 低嚴重度 UI/UX 修正（9 項）

- **L1** 版本號改用 `APP_VERSION` 常數統一管理，不再散落 6 處
- **L2** 暫存池 max-height 改用 `min(px, vh)` 相對單位，跨斷點平滑過渡
- **L3** 賽事標題輸入框改用 `min(280px, 60vw)`，窄螢幕不溢出
- **L4** `.score-input` 移除 `!important`，改用高精確度選擇器 `.match-row .score-input`
- **L5** Toast 加入 `env(safe-area-inset)` fallback，相容不支援的瀏覽器
- **L7** 空狀態 emoji 加入跨平台 font-family（Apple/Segoe/Noto Color Emoji）
- **L9** 暗黑模式獎牌卡片文字改為白色，`.medal-label` 對比度提升
- **L10** 全場總覽表加入 `overflow-x: auto` 容器，手機可橫向捲動
- **L12** 智慧分組按鈕文字精簡為「智慧分組」，詳細說明移入 title 提示

## v1.13

### 2026-02-19

- 修正：非滿員 bracket 季軍不再顯示 —BYE—（從準決賽敗者中過濾 BYE/TBD）

## v1.12

### 2026-02-19

- 決賽按鈕列：移除「匯出工具」折疊選單，所有按鈕同列顯示（flex-wrap 自動換行）

## v1.11

### 2026-02-19

- 自主棄權選手不得晉級：戰績表顯示「棄（不晉級）」、列灰顯、不出現晉級勾選
- `getGroupQualifiers()` 自動排除自主棄權選手（含平手投票路徑）

## v1.10

### 2026-02-19

#### UI/UX 全面改善（19 項修正）

**高嚴重度修正：**
- **H1** Header 手機版自動換行（flex-wrap），按鈕收進 `.header-right` 群組
- **H2** 預賽控制台重新分群：檔案管理 / 匯出報表 / 結算冠軍（移到最下方避免誤觸）
- **H3** 決賽按鈕列精簡：主要操作 3 個 + 「匯出工具」折疊區
- **H4** 棄權按鈕加大觸控範圍（28px + 隱形擴大 ::before）
- **H5** 隱藏分數輸入框的 number spinner（webkit + moz）
- **H6** 暗黑模式 warning 按鈕/toast 改為深琥珀色 + 白字，提升對比度
- **H7** ARIA tabs 完善：加入 id、tabindex、aria-labelledby

**中嚴重度修正：**
- **M1** 空狀態文字「從左側新增」改為「請先新增」（適應手機單欄佈局）
- **M2** 暫存池「載入編輯 / 刪除選取」未選取時自動 disabled
- **M3** 原生 confirm() 全部替換為自訂 modal 確認對話框
- **M4** 手機版進度面板文字限高 + 可展開
- **M5** 暗黑模式平手列加深背景色 + 左側橘色邊框
- **M6** 分數輸入加入 max="99" 限制
- **M7** 賽事標題旁加鉛筆圖示提示可編輯
- **M8** 「結算冠軍」按鈕在無分數時自動 disabled
- **M9** Modal 支援 Escape 鍵關閉
- **M10** `<hr>` 改用 CSS 變數顏色，暗黑模式正常顯示
- **M11** 對戰圖加「← 滑動查看 →」提示
- **M12** 「計算戰績」按鈕改為藍色主按鈕，更醒目

**其他：**
- 暗黑模式切換按鈕 Dark/Light → 深色/淺色

---

## v1.9.2

### 2026-02-19

#### 修正：平手重算 + 決賽棄賽
- **平手重算**：重新計算戰績時自動清除舊的平手勾選，可正確重新選擇晉級者
- **決賽棄賽**：決賽評分表新增棄賽按鈕（傷/棄），行為與預賽一致（主動棄權鎖 0 分、因傷可改分數）

---

## v1.9.1

### 2026-02-19

#### 修正：預賽計分版面 + 棄權鎖分
- **版面修正**：預賽計分欄位強制單行顯示（選手①  分數  VS  分數  選手②），不再換行
- **棄權即鎖分**：主動棄權自動設為 0 分並鎖定輸入框，因傷棄權可自由輸入分數
- **CSS 修正**：修正 `input[type=number]` 特異性覆蓋 `.score-input` 寬度的問題
- **ff-badge 還原**：棄權按鈕恢復早期緊湊尺寸（26×22px）

---

## v1.9

### 2026-02-19

#### 功能新增：多項目決賽（Multi-Category Finals）
- **每個類別獨立決賽**：
  - 結算冠軍後，每個類別（如四男單、四女單、五男單）各自擁有獨立的晉級名單、淘汰賽對戰圖、冠亞季殿
  - 不再將所有類別的晉級者混進同一個 bracket
- **決賽類別 Tab**：
  - 決賽面板新增類別 Tab Bar，點擊切換不同類別的決賽
  - 每個 Tab 顯示狀態 badge（已完賽/進行中）
  - 各類別可獨立操作：手動抽籤、產生對戰圖、確認勝者
- **全場總覽面板**：
  - 新增「全場總覽」Tab，顯示所有類別的賽程狀態表
  - 包含：組別、晉級人數、狀態（已完賽/進行中/未開始）、冠亞季
  - 點擊「管理」按鈕快速跳轉到該類別
- **綜合報表升級**：
  - 綜合成績報表自動包含所有類別的決賽成績
  - 每個類別獨立一區，含領獎台 + 對戰明細
- **決賽 Excel 升級**：
  - 下載決賽 Excel 時，每個類別獨立一個 sheet
  - 含晉級名單 + 比賽結果（冠亞季殿）
- **對戰圖升級**：
  - 列印/下載對戰圖時自動加上類別名稱前綴
  - 多角對戰圖（Chart View）為每個類別產生獨立的 bracket SVG 頁面
- **向下相容**：
  - 自動偵測舊版存檔（扁平格式）並遷移為新的 per-category 格式
  - localStorage 和 Excel 存檔均支援新舊格式自動轉換
  - Undo/Redo 快照同步支援新格式
- **版本號更新**：v1.8 → v1.9

---

## v1.8

### 2026-02-19

#### UI/UX 優化
- **Toast 通知強化**：
  - 錯誤/警告類延長至 4 秒（原 2.5 秒）
  - 手機端改為底部顯示，避免被瀏海/動態島遮擋
  - 新增陰影提升可見度，前一則 toast 自動清除
- **棄權徽章觸控加大**：min-width/height 36px → 44px（符合 WCAG 標準），新增按壓縮放回饋
- **控制列分層排版**：
  - 「結算冠軍」獨立置頂全寬，一眼可見
  - 其餘按鈕分為「存檔/載入」與「報表/出賽單」兩組，手機端分隔線區分
- **分數輸入框響應式**：移除 `!important`，改用 `clamp(56px, 14vw, 70px)` 自適應寬度
- **Modal 關閉鈕可及性**：加大至 36×36px、新增 `aria-label="關閉"`、hover 背景色、focus 外框
- **棄權選手辨識強化**：
  - 傷棄選手名加橘色背景底色
  - 主動棄權選手名加紅色背景底色 + 紅字（原為灰色刪除線）
  - 暗色模式下加深背景確保對比度
- **戰績表手機版**：字體 11px → 12px，新增橫向滾動支援，防止數據被截斷
- **比賽列手機對齊**：禁止換行（`flex-wrap: nowrap`），改為橫向滾動保持對齊
- **Tab 鍵盤導航**：
  - 新增 ARIA `role="tab/tablist/tabpanel"` + `aria-selected`
  - 支援左右方向鍵切換分頁
- **進度條升級**：高度 8px → 20px，內嵌「已完成 / 總計（百分比）」文字標籤
- **暗色模式獎牌**：金/銀/銅底色飽和度提高，邊框同步調亮
- **Bracket 輸入框**：padding 4px → 6px、寬度 48px → 52px，與預賽輸入框視覺統一
- **Focus 可及性**：鍵盤 focus 顯示 2px 藍色外框，滑鼠 focus 不顯示（`:focus-visible`）
- **版本號更新**：v1.7 → v1.8

---

## v1.7

### 2026-02-19

#### 程式碼優化
- **提取共用工具函式**：
  - `getMatchScores(matchId)` — 取代 14 處重複的分數 DOM 取值 pattern
  - `collectForfeitPlayers(group)` — 取代 4 處重複的棄權玩家收集邏輯
  - `getBracketRoundCount(matches)` — 取代 5 處重複的 bracket 輪次計算
  - `getRoundName(roundIndex, totalRounds)` — 取代 5 處重複的輪次名稱邏輯
  - `detectTiedGroup(ranked, nQualify)` — 取代 3 處重複的平手偵測邏輯
- **全域常數**：
  - `ROUND_NAMES` — 輪次名稱陣列統一定義
  - `FF_TYPES` — 棄權類型常數（`NONE`/`INJURY`/`VOLUNTARY`），取代散落各處的魔術字串
- **效能優化**：
  - `updateProgress()` 使用 `requestAnimationFrame` 節流，避免每次按鍵重複遍歷所有 DOM
- **拆分大型函式**：
  - `generateFullReport()` 200+ 行拆分為 4 個子函式：`_writeReportCSS`、`_writeReportPrelimSection`、`_writeReportFinalsSection`、`_writeReportPDFScript`
- **版本號更新**：v1.6 → v1.7

---

## v1.6

### 2026-02-19

#### 功能新增
- **PWA 離線支援**：
  - 新增 `manifest.json` + `sw.js` Service Worker
  - 安裝時快取主頁面及所有 CDN 資源（XLSX、html2canvas、jsPDF、qrcode-generator）
  - 斷網後仍可正常使用所有功能
  - 支援「加到主畫面」安裝為 App
- **QR Code 分享**：
  - Header 新增「分享」按鈕
  - 點擊顯示 QR Code modal（SVG 格式），掃碼即可開啟頁面
  - 含「複製連結」按鈕
- **截圖分享**：
  - 預賽控制台 + 決賽管理區新增「截圖」按鈕
  - 使用 html2canvas 擷取畫面為 PNG
  - 手機觸發原生分享（LINE/WhatsApp 等）
  - 電腦自動下載 PNG 圖片
  - html2canvas 改為主頁面直接載入（不再僅限新視窗動態注入）
- **多賽事管理**：
  - Header 新增「賽事」按鈕，點擊開啟賽事管理 modal
  - 支援新增、切換、刪除多場賽事
  - 每場賽事獨立 localStorage 儲存
  - 賽事列表顯示名稱 + 最後更新時間
  - 目前進行中的賽事標記「進行中」
  - 向下相容：首次開啟自動遷移舊資料為第一場賽事
- **版本號更新**：v1.5 → v1.6

#### Bug 修復
- **QR Code 複製按鈕無反應**：改用 `addEventListener` 綁定事件（取代 inline onclick XSS 風險寫法）
- **escapeXml 未處理引號**：新增 `"` 和 `'` 跳脫，避免 HTML 屬性注入
- **loadState 殘留舊資料**：改為無條件賦值（`saved.x || default`），載入空存檔時正確清除舊 bracketMatches 等欄位
- **loadFromExcel 殘留舊資料**：同上修法，並清除 undo/redo 歷史
- **loadFromExcel 缺確認對話框**：已有資料時跳出確認提示，避免誤覆蓋
- **createNewEvent 未清除 undo/redo**：新增 `undoStack/redoStack.length = 0`，防止復原到舊賽事資料
- **createNewEvent 未清除 finalTitle**：新賽事時重置決賽標題欄位
- **loadState eventId 未排序**：取最近更新的賽事 ID（依 updatedAt 降序排序）

---

## v1.5

### 2026-02-19

#### 功能新增
- **危險操作確認對話框**：
  - 「刪除選取」名單：新增確認提示
  - 「智慧分組」：已有預賽資料時跳出確認，避免誤覆蓋
  - 「手動抽籤」：新增確認提示
  - 「產生對戰圖」：已有決賽資料時跳出確認，避免誤覆蓋
- **綜合成績報表**：
  - 預賽控制台新增「綜合報表」按鈕
  - 一鍵產生完整預賽 + 決賽成績報表（開新視窗）
  - 預賽區：各類別各組戰績表（排名、勝負、得失分、棄權備註），晉級者綠色標記
  - 決賽區：冠亞季殿領獎台 + 各輪對戰明細（含季軍賽）
  - 支援列印及下載 PDF（html2canvas + jsPDF，自動分頁）
- **版本號更新**：v1.4 → v1.5

---

## v1.4

### 2026-02-19

#### 功能新增
- **季軍賽（3rd Place Match）**：
  - 4 人以上決賽自動產生季軍賽，準決賽敗者自動填入季軍賽對陣
  - 季軍賽獨立區塊顯示於對戰圖下方，支援即時計分與確認勝者
  - 結果卡顯示冠軍、亞軍、季軍、殿軍（第四名）
  - 成績公告同步更新，包含季軍賽對戰明細
- **預賽分數即時驗證**：
  - 輸入負數自動歸零並 toast 提示「分數不可為負數」
  - 同場雙方皆輸入 0 分時顯示警告提醒
  - 決賽確認勝者增加負數檢查
  - 預賽與決賽 bracket 輸入框皆適用
- **鍵盤快速輸入**：
  - Enter 鍵自動跳到下一個分數輸入框（預賽 + 決賽）
  - Focus 時自動全選文字，方便直接覆寫
- **進度總覽面板**：
  - 預賽控制台上方新增進度面板，顯示整體完成百分比與進度條
  - 各組個別顯示完成場數，全部完成的組別標記綠色勾勾
  - 輸入分數、切換棄權即時更新進度
  - 考慮棄權場次（有棄權標記即算完成）
- **版本號更新**：v1.3 → v1.4

---

## v1.3

### 2026-02-19

#### 功能新增
- **決賽即時計分**：
  - 「產生對戰圖」改為互動式，每場可直接輸入雙方分數
  - 「確認勝者」按鈕自動比較分數、判定勝者並推進至下一輪
  - 勝者 slot 綠色高亮，已確認按鈕顯示勝者姓名
  - 全部決賽打完後自動顯示冠軍🥇、亞軍🥈、季軍🥉結果卡片
  - 對戰圖狀態（`state.bracketMatches`）納入 localStorage / Excel 持久化
- **撤銷 / 重做 (Undo/Redo)**：
  - 預賽控制台新增「↩ 復原」「↪ 重做」按鈕
  - 快捷鍵 Ctrl+Z / Ctrl+Y（Mac: Cmd+Z / Cmd+Y）
  - 最多保留 30 步歷史，涵蓋分數輸入、棄權、平手勾選、分組、結算等操作
  - 分數輸入使用 1 秒防抖，避免每次按鍵都推入歷史
- **賽事標題設定**：
  - Header 標題可點擊編輯，輸入自訂賽事名稱（如「114 年主委盃羽球錦標賽」）
  - 標題持久化至 localStorage / Excel 存檔
  - 自動套用到出賽單、對戰圖列印、Excel 報表等所有輸出
  - 瀏覽器 title 同步更新
- **版本號更新**：v1.0 → v1.3

---

## v1.2

### 2026-02-19

#### 手機端操作體驗優化
- **RWD 響應式設計**：新增 768px（平板）及 480px（手機）兩組 media query 斷點
- **預賽控制台**：手機時改為 2 欄 grid 佈局，7 個按鈕不再擠在一列；「結算冠軍」獨占整列
- **決賽 action-bar**：加入 `flex-wrap`，手機時按鈕自動排成 2×3 網格
- **按鈕觸控目標**：所有按鈕加入 `min-height: 44px`（Apple HIG 標準）
- **棄權徽章加大**：觸控區從 26×22px → 36×36px，手機上不再難以點擊
- **分數輸入框**：手機時寬度 70px → 56px，避免擠壓選手名稱
- **輸入框 font-size**：14px → 16px，避免 iOS Safari 自動縮放
- **Toast 通知**：使用 `env(safe-area-inset-top)` 適配瀏海/動態島，加入 `max-width` 防溢出
- **列表高度響應**：暫存池/晉級名單在小螢幕自動縮減高度
- **整體間距優化**：Header、卡片、Tab、戰績表等元素在手機端縮減 padding
- **對戰圖**：手機端 bracket-round 寬度及間距縮減，減少橫向捲動

---

## v1.1

### 2026-02-15

#### 功能新增
- **棄權徽章可視化**：預賽計分每位選手旁顯示可點擊的「棄」徽章，點擊循環切換：未啟用 → 傷（橘色）→ 棄（紅色），字體加大至 15px
- **選手名稱自動對齊**：
  - `alignName()` + `getAlignWidths()` 動態計算同組最大學校名/姓名字數
  - 使用 CSS `text-align-last: justify` 搭配固定寬度，不論 2～5 字學校名或 2～3 字姓名皆自動均勻對齊
  - 套用範圍：預賽計分、重建 UI、戰績表、決賽晉級名單
- **決賽評分表**：新增「產生對戰表」按鈕，根據抽籤結果產生各輪次評分表（含分數輸入欄位、輪空處理）
- **列印決賽對戰圖**：新增「列印對戰圖」按鈕，開啟新視窗預覽樹狀對戰圖，支援列印及下載 PDF（jsPDF、自動橫/直向）
- **平手偵測與手動晉級確認**：
  - 戰績表自動偵測晉級邊界的平手（勝負場數相同即觸發，不需淨分也相同）
  - 平手列黃色底色標示，備註欄顯示橘色「平手」
  - 表格上方顯示警告，平手選手前方出現 checkbox 供手動勾選晉級者
  - 勾選超過名額自動退回並提示
  - 「結算冠軍」時檢查未解決的平手，阻擋並提示需先勾選
  - 勾選結果持久化至 localStorage 及 Excel 存檔
- **出賽單（預賽 + 決賽）**：
  - 參考「114 年臺南市主委盃羽球錦標賽」格式
  - 預賽控制台、決賽管理區各新增「產生出賽單」按鈕
  - 每張含：賽事名稱、組別場次、選手框（單打 1 列/雙打 2 列）、Score 欄、勝方/裁判/裁判長簽名欄
  - 每頁 2 張出賽單（精確半頁 A4），支援列印及下載 PDF（html2canvas + jsPDF）
  - 日期欄含 `/` 分隔（年/月/日），時間欄含 `:` 分隔（時:分）
  - 雙打自動拆分成員名稱（支援「/」分隔或空格拆分）
  - 比分標籤改為中文「比分」、日期時間分列、場地欄底線加長
- **戰績表備註欄區分棄權類型**：因傷棄權顯示橘色「傷」、主動棄權顯示紅色「棄」
- **決賽晉級名單樣式調整**：數字圓圈 30px、文字 16px、間距加大，貼近實際使用截圖
- **GitHub Pages 部署**：https://nan786521.github.io/badminton-tournament/

---

## v1.0 Web Edition

### 2026-02-15

#### 功能新增
- **選手棄權（雙類型）**：
  - 每場比賽可選擇「傷」（受傷棄權）或「棄」（主動棄權）
  - 受傷棄權：可輸入分數、分數計入統計，判負但後續比賽可繼續
  - 主動棄權：0 分、後續所有比賽自動連鎖棄權
  - 戰績表新增棄權欄，主動棄權者備註顯示紅色「棄」
  - Excel 報表區分「受傷棄權」/「主動棄權」，對戰矩陣顯示「棄」或「分數(傷)」
- **Python → Web 轉換**：將原 tkinter 桌面程式完整轉換為單頁 HTML/CSS/JS 網頁應用
- **Excel 匯入**：支援 `.xlsx/.xls` 批次匯入名單，自動偵測標頭列跳過
- **下載範本**：產生含 4 個分頁（男單、女單、男雙、混雙）的 Excel 範本檔
- **多角對戰圖（SVG）**：
  - 三角形（3人組）、方塊+X（4人組）、直線（2人組）
  - `*N` 格式場次編號（黑色）
  - 選手標籤兩行顯示（學校 + 姓名），自動去除賽制前綴
  - 每列 2 組、每頁最多 3 列
  - 左上角顯示賽制/組數/晉級資訊
- **對戰圖輸出**：支援列印、下載 SVG、下載 PDF（JPEG 壓縮 + 1.5x 縮放）
- **Excel 成績報表**：含多角對戰矩陣表、場次明細、勝負淨分排名
- **智慧分組**：選手去重、3人組為主、餘數改用4人組、5人拆為3+2
- **單淘汰決賽**：晉級名單管理、手動抽籤、對戰表（含輪空處理）
- **暗黑模式**：Header 切換按鈕，CSS 變數統一管理，localStorage 記住偏好
- **資料持久化（localStorage）**：
  - 名單、分組、比分、晉級名單自動儲存
  - 頁面重整後自動還原，含 `beforeunload` 保底
  - 預賽控制台顯示「已自動儲存」時間戳
- **存檔/載入存檔（Excel）**：
  - 「存檔」按鈕：將完整賽事資料匯出為 `.xlsx`（含 `_state` 資料頁 + 人類可讀分頁）
  - 「載入存檔」按鈕：從存檔 Excel 還原所有資料
- **暫存池全部清空**：新增「全部清空」按鈕，含確認對話框

#### Bug 修復
- **匯入錯誤**：`refreshPoolList()` 使用 `innerHTML=''` 銷毀 `#poolEmpty` DOM 元素，第二次呼叫時 `getElementById` 回傳 null 導致 TypeError → 改用 `querySelectorAll` 選擇性移除
- **決賽名單同樣 bug**：`renderFinalsList()` 有相同的 `#finalsEmpty` 銷毀問題 → 同樣修法
- **`</script>` 破壞主頁面**：子視窗 `document.write()` 中的 `</script>` 被瀏覽器誤判為關閉主 script 標籤 → 改用 `'<scr' + 'ipt>'` 拆分寫法
- **Excel 匯入含標頭列**：第一列含「學校」「姓名」等關鍵字時被當作選手 → 新增 headerKeywords 跳過檢查
- **賽制名稱出現在選手標籤**：如「四女單 仁愛國小 陳怡昊」→ 新增 `cat` 參數至 `playerLabel()` 去除前綴
- **5人單組無法繪圖**：對戰圖僅支援 2/3/4 人組，5人改回 3+2 拆分
- **PDF/SVG 下載按鈕無反應**：子視窗 event listener 在 `doc.close()` 後失效 → 改用 inline script 注入
- **PDF 檔案過大**：PNG → JPEG（quality 0.75）、縮放 2x → 1.5x、jsPDF compress:true

#### 程式碼優化
- `getQualifyCount()` 無效三元運算 `nMembers <= 3 ? 2 : 2` → 簡化為直接 `return 2`
- `generateExcel()` 重複計分邏輯 → 改為重用 `getScores()` 函式
- 移除未使用變數 `totalPlayers`
- 成績輸入欄位寬度 50px → 70px

---

## 待辦 / 已知問題
- 無
