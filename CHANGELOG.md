# 羽球賽務系統 — 修改紀錄

## v19.1

### 2026-02-15

#### 功能新增
- **棄權徽章可視化**：預賽計分每位選手旁顯示可點擊的「棄」徽章，點擊循環切換：未啟用 → 傷（橘色）→ 棄（紅色），字體加大至 15px
- **選手名稱自動對齊**：
  - `alignName()` + `getAlignWidths()` 動態計算同組最大學校名/姓名字數
  - 使用 CSS `text-align-last: justify` 搭配固定寬度，不論 2～5 字學校名或 2～3 字姓名皆自動均勻對齊
  - 套用範圍：預賽計分、重建 UI、戰績表、決賽晉級名單
- **決賽評分表**：新增「產生對戰表」按鈕，根據抽籤結果產生各輪次評分表（含分數輸入欄位、輪空處理）
- **列印決賽對戰圖**：新增「列印對戰圖」按鈕，開啟新視窗預覽樹狀對戰圖，支援列印及下載 PDF（jsPDF、自動橫/直向）
- **平手偵測與手動晉級確認**：
  - 戰績表自動偵測晉級邊界的平手（勝場數 + 淨分皆相同）
  - 平手列黃色底色標示，備註欄顯示橘色「平手」
  - 表格上方顯示警告，平手選手前方出現 checkbox 供手動勾選晉級者
  - 勾選超過名額自動退回並提示
  - 「結算冠軍」時檢查未解決的平手，阻擋並提示需先勾選
  - 勾選結果持久化至 localStorage 及 Excel 存檔
- **出賽單（預賽 + 決賽）**：
  - 參考「114 年臺南市主委盃羽球錦標賽」格式
  - 預賽控制台、決賽管理區各新增「產生出賽單」按鈕
  - 每張含：賽事名稱、組別場次、選手框（單打 1 列/雙打 2 列）、Score 欄、勝方/裁判/裁判長簽名欄
  - 每頁 2 張出賽單（精確半頁 A4），支援列印及下載 PDF（html2canvas + jsPDF）
  - 日期欄含 `/` 分隔（年/月/日），時間欄含 `:` 分隔（時:分）
  - 雙打自動拆分成員名稱（支援「/」分隔或空格拆分）
- **決賽晉級名單樣式調整**：數字圓圈 30px、文字 16px、間距加大，貼近實際使用截圖

---

## v19.0 Web Edition

### 2026-02-15

#### 功能新增
- **選手棄權（雙類型）**：
  - 每場比賽可選擇「傷」（受傷棄權）或「棄」（主動棄權）
  - 受傷棄權：可輸入分數、分數計入統計，判負但後續比賽可繼續
  - 主動棄權：0 分、後續所有比賽自動連鎖棄權
  - 戰績表新增棄權欄，主動棄權者備註顯示紅色「棄」
  - Excel 報表區分「受傷棄權」/「主動棄權」，對戰矩陣顯示「棄」或「分數(傷)」
- **Python → Web 轉換**：將原 tkinter 桌面程式完整轉換為單頁 HTML/CSS/JS 網頁應用
- **Excel 匯入**：支援 `.xlsx/.xls` 批次匯入名單，自動偵測標頭列跳過
- **下載範本**：產生含 4 個分頁（男單、女單、男雙、混雙）的 Excel 範本檔
- **多角對戰圖（SVG）**：
  - 三角形（3人組）、方塊+X（4人組）、直線（2人組）
  - `*N` 格式場次編號（黑色）
  - 選手標籤兩行顯示（學校 + 姓名），自動去除賽制前綴
  - 每列 2 組、每頁最多 3 列
  - 左上角顯示賽制/組數/晉級資訊
- **對戰圖輸出**：支援列印、下載 SVG、下載 PDF（JPEG 壓縮 + 1.5x 縮放）
- **Excel 成績報表**：含多角對戰矩陣表、場次明細、勝負淨分排名
- **智慧分組**：選手去重、3人組為主、餘數改用4人組、5人拆為3+2
- **單淘汰決賽**：晉級名單管理、手動抽籤、對戰表（含輪空處理）
- **暗黑模式**：Header 切換按鈕，CSS 變數統一管理，localStorage 記住偏好
- **資料持久化（localStorage）**：
  - 名單、分組、比分、晉級名單自動儲存
  - 頁面重整後自動還原，含 `beforeunload` 保底
  - 預賽控制台顯示「已自動儲存」時間戳
- **存檔/載入存檔（Excel）**：
  - 「存檔」按鈕：將完整賽事資料匯出為 `.xlsx`（含 `_state` 資料頁 + 人類可讀分頁）
  - 「載入存檔」按鈕：從存檔 Excel 還原所有資料
- **暫存池全部清空**：新增「全部清空」按鈕，含確認對話框

#### Bug 修復
- **匯入錯誤**：`refreshPoolList()` 使用 `innerHTML=''` 銷毀 `#poolEmpty` DOM 元素，第二次呼叫時 `getElementById` 回傳 null 導致 TypeError → 改用 `querySelectorAll` 選擇性移除
- **決賽名單同樣 bug**：`renderFinalsList()` 有相同的 `#finalsEmpty` 銷毀問題 → 同樣修法
- **`</script>` 破壞主頁面**：子視窗 `document.write()` 中的 `</script>` 被瀏覽器誤判為關閉主 script 標籤 → 改用 `'<scr' + 'ipt>'` 拆分寫法
- **Excel 匯入含標頭列**：第一列含「學校」「姓名」等關鍵字時被當作選手 → 新增 headerKeywords 跳過檢查
- **賽制名稱出現在選手標籤**：如「四女單 仁愛國小 陳怡昊」→ 新增 `cat` 參數至 `playerLabel()` 去除前綴
- **5人單組無法繪圖**：對戰圖僅支援 2/3/4 人組，5人改回 3+2 拆分
- **PDF/SVG 下載按鈕無反應**：子視窗 event listener 在 `doc.close()` 後失效 → 改用 inline script 注入
- **PDF 檔案過大**：PNG → JPEG（quality 0.75）、縮放 2x → 1.5x、jsPDF compress:true

#### 程式碼優化
- `getQualifyCount()` 無效三元運算 `nMembers <= 3 ? 2 : 2` → 簡化為直接 `return 2`
- `generateExcel()` 重複計分邏輯 → 改為重用 `getScores()` 函式
- 移除未使用變數 `totalPlayers`
- 成績輸入欄位寬度 50px → 70px

---

## 待辦 / 已知問題
- 無
